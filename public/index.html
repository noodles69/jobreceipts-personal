<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .item-row input {
            margin-bottom: 0;
        }
        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-btn, .generate-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .generate-btn {
            background-color: #28a745;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            margin-top: 20px;
        }
        .add-btn:hover, .generate-btn:hover {
            opacity: 0.9;
        }
        #total-display {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 style="text-align: center; color: #333;">Invoice Generator</h1>
        
        <form id="invoiceForm">
            <!-- Company Information -->
            <div class="section">
                <h3>Company Information</h3>
                <div class="form-group">
                    <label>Company Name:</label>
                    <input type="text" id="companyName" value="">
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="text" id="companyPhone" value="">
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="companyEmail" value="">
                </div>
            </div>

            <!-- Customer Information -->
            <div class="section">
                <h3>Customer Information</h3>
                <div class="form-group">
                    <label>Customer Name:</label>
                    <input type="text" id="customerName" value="" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Address:</label>
                    <input type="text" id="customerAddress" value="" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>City:</label>
                    <input type="text" id="customerCity" value="" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>State:</label>
                    <input type="text" id="customerState" value="" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>Zip Code:</label>
                    <input type="text" id="customerZip" value="" autocomplete="off">
                </div>
            </div>

            <!-- Items -->
            <div class="section">
                <h3>Invoice Items</h3>
                <div id="itemsContainer">
                    <div class="item-row">
                        <div>
                            <label>Item Name:</label>
                            <input type="text" class="item-name" value="New Equipment">
                        </div>
                        <div>
                            <label>Description:</label>
                            <input type="text" class="item-description" value="Air Handler">
                        </div>
                        <div>
                            <label>Unit Cost:</label>
                            <input type="number" class="item-cost" value="1800" step="0.01" min="0">
                        </div>
                        <div>
                            <label>Quantity:</label>
                            <input type="number" class="item-quantity" value="1" min="1">
                        </div>
                        <div>
                            <button type="button" class="remove-btn" onclick="removeItem(this)">Remove</button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-btn" onclick="addItem()">Add Item</button>
                <div id="total-display">Total: $0.00</div>
            </div>

        <!-- Invoice Details -->
            <div class="section">
                <h3>Invoice Details</h3>
                <div class="form-group">
                    <label>Invoice Number:</label>
                    <input type="text" id="invoiceNumber" placeholder="">
                    <small style="color: #666;">Leave blank for it to be today's date and a random number.</small>
                </div>
                <div class="form-group">
                    <label>Amount Paid:</label>
                    <input type="number" id="amountPaid" value="" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label>Footnote:</label>
                    <textarea id="noteadd" rows="3" placeholder="Payment is due upon job completion. Thank you for your business."></textarea>
                </div>
            </div>

            <button type="submit" class="generate-btn">Generate Invoice PDF</button>
        </form>
    </div>

    <script>
        function addItem() {
            const container = document.getElementById('itemsContainer');
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.innerHTML = `
                <div>
                    <label>Item Name:</label>
                    <input type="text" class="item-name" value="">
                </div>
                <div>
                    <label>Description:</label>
                    <input type="text" class="item-description" value="">
                </div>
                <div>
                    <label>Unit Cost ($):</label>
                    <input type="number" class="item-cost" value="0" step="0.01" min="0">
                </div>
                <div>
                    <label>Quantity:</label>
                    <input type="number" class="item-quantity" value="1" min="1">
                </div>
                <div>
                    <button type="button" class="remove-btn" onclick="removeItem(this)">Remove</button>
                </div>
            `;
            container.appendChild(itemRow);
            
            // Event listeners for the new inputs
            const newInputs = itemRow.querySelectorAll('.item-cost, .item-quantity');
            newInputs.forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
            
            calculateTotal();
        }

        function removeItem(button) {
            button.closest('.item-row').remove();
            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            const itemRows = document.querySelectorAll('.item-row');
            
            itemRows.forEach(row => {
                const cost = parseFloat(row.querySelector('.item-cost').value) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                total += cost * quantity;
            });
            
            document.getElementById('total-display').textContent = `Total: $${total.toFixed(2)}`;
        }

        document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const button = document.querySelector('.generate-btn');
            button.textContent = 'Generating PDF...';
            button.disabled = true;
            
            try {
                const items = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const name = row.querySelector('.item-name').value;
                    const description = row.querySelector('.item-description').value;
                    const cost = parseFloat(row.querySelector('.item-cost').value) || 0;
                    const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                    
                    if (name || description || cost > 0) {
                        items.push({
                            item: name,
                            description: description,
                            unitCost: cost,
                            quantity: quantity
                        });
                    }
                });

                const invoiceData = {
                    company: {
                        cmpyname: document.getElementById('companyName').value,
                        phone: document.getElementById('companyPhone').value,
                        email: document.getElementById('companyEmail').value
                    },
                    customer: {
                        name: document.getElementById('customerName').value,
                        address: document.getElementById('customerAddress').value,
                        city: document.getElementById('customerCity').value,
                        state: document.getElementById('customerState').value,
                        zip: document.getElementById('customerZip').value
                    },
                    items: items,
                    paid: parseFloat(document.getElementById('amountPaid').value) || 0,
                    invoiceNumber: document.getElementById('invoiceNumber').value || undefined,
                    noteadd: document.getElementById('noteadd').value || ""
                };

                const response = await fetch('/generate-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });

                if (response.ok) {
            const blob = await response.blob();
            
            if (blob.size === 0) {
                alert('Error: PDF file is empty');
                return;
            }
            
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            // Get filename from Content-Disposition header or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            console.log('Content-Disposition:', contentDisposition);
            
            let filename = 'invoice.pdf';
            if (contentDisposition && contentDisposition.includes('filename=')) {
                const match = contentDisposition.match(/filename[*]?=['"]?([^'";]+)['"]?/);
                if (match && match[1]) {
                    filename = match[1];
                }
            }
            
            console.log('Using filename:', filename);
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            
            // Clean up after a short delay
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        } else {
            // Handle non-JSON error responses
            let errorMessage = 'An error occurred';
            try {
                const error = await response.json();
                errorMessage = error.error || errorMessage;
            } catch {
                errorMessage = `Server error: ${response.status} ${response.statusText}`;
            }
            alert('Error: ' + errorMessage);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while generating the invoice');
    } finally {
        button.textContent = 'PDF Downloaded To Device'
        setTimeout(function() {
        button.textContent = 'Generate Invoice PDF';
        button.disabled = false;
        }, 5000);
    }
});

        // Event listeners for real-time total calculation
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('.item-cost, .item-quantity');
            inputs.forEach(input => {
                input.addEventListener('input', calculateTotal);
            });
            calculateTotal();
        });
    </script>
</body>
</html>